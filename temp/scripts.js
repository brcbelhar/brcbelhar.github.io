const scriptURL="https://script.google.com/macros/s/AKfycbzxDmBbqQaSbdqPJWsL-c8UV0xbQpE-RlzLKsq5AZZ42Ur9uWCk0AVV9ql1UOOQ9lBS/exec",form=document.getElementById("dataForm"),btn=document.getElementById("submitBtn"),status=document.getElementById("statusMessage"),loader=document.getElementById("loader"),popup=document.getElementById("successPopup"),closePopupBtn=document.getElementById("closePopupBtn"),popupTitle=popup.querySelector("h3"),popupMessage=popup.querySelector("p"),aadhaarSection=document.getElementById("aadhaarSection"),udiseSection=document.getElementById("udiseSection"),nameSection=document.getElementById("nameSection"),formView=document.getElementById("formView"),backToModeBtn=document.getElementById("backToModeBtn"),panPopup=document.getElementById("panPopup"),panInput=document.getElementById("panInput"),panTeacherName=document.getElementById("panTeacherName"),savePanBtn=document.getElementById("savePanBtn"),cancelPanBtn=document.getElementById("cancelPanBtn");let currentEditAadhaar=null;function setMode(e){window.location.hash=e}function showSectionFromHash(){const e=window.location.hash.substring(1);aadhaarSection.classList.add("hidden"),udiseSection.classList.add("hidden"),nameSection.classList.add("hidden"),formView.classList.add("hidden"),document.getElementById("udiseResultList").innerHTML="",document.getElementById("nameResultList").innerHTML="",status.innerText="","aadhaar"===e?aadhaarSection.classList.remove("hidden"):"udise"===e?udiseSection.classList.remove("hidden"):"name"===e?nameSection.classList.remove("hidden"):"add"===e&&(formView.classList.remove("hidden"),form.reset())}function searchData(){const e=document.getElementById("searchAdhaar").value;12===e.length?(status.innerText="Searching...",status.style.color="blue",loader.style.display="flex",fetch(`${scriptURL}?action=read&adhaar=${e}`).then((e=>e.json())).then((e=>{if(loader.style.display="none","found"===e.result){populateFormFromRow(e.row),setMode("add"),status.innerText="Data found! You can now edit and re-submit.",status.style.color="green",popupTitle.innerText="Record Found",popupMessage.innerText="Data found! You can now edit and re-submit.",popup.style.display="flex"}else status.innerText="No record found. Please fill as new.",status.style.color="red",popupTitle.innerText="No Record",popupMessage.innerText="No record found. Please fill as new.",popup.style.display="flex"})).catch((e=>{loader.style.display="none",alert("Error searching data.")}))):alert("Enter 12-digit Adhaar")}function searchByUDISE(){const e=document.getElementById("searchUdise").value;if(!e.match(/^\d{5}$/))return void alert("Please enter exactly 5 digits (last part of UDISE code).");const t="102328"+e;status.innerText="Searching...",status.style.color="blue",loader.style.display="flex",fetch(`${scriptURL}?action=readByUDISE&udise=${t}`).then((e=>e.json())).then((e=>{loader.style.display="none";const t=document.getElementById("udiseResultList");if("found"===e.result&&e.rows&&e.rows.length>0){let n="<ul>";e.rows.forEach(((e,t)=>{const a=e[1]||"Unknown",o=""!==(e[23]||"").trim();n+=`<li>\n                        <span>${o?`${a} <span class="pan-tick">✓</span>`:a}</span>\n                        <button type="button" onclick="openPanPopup('${e[4]}', '${a}')">Edit PAN</button>\n                    </li>`})),n+="</ul>",t.innerHTML=n,status.innerText=`${e.rows.length} record(s) found.`,status.style.color="green"}else t.innerHTML='<p style="color:red; text-align:center;">No records found for this UDISE.</p>',status.innerText="No records found.",status.style.color="red"})).catch((e=>{loader.style.display="none",alert("Error searching by UDISE.")}))}function searchByName(){const e=document.getElementById("searchName").value.trim();""!==e?(status.innerText="Searching...",status.style.color="blue",loader.style.display="flex",fetch(`${scriptURL}?action=searchByName&name=${encodeURIComponent(e)}`).then((e=>e.json())).then((e=>{loader.style.display="none";const t=document.getElementById("nameResultList");if("found"===e.result&&e.rows&&e.rows.length>0){let n="<ul>";e.rows.forEach(((e,t)=>{const a=e[1]||"Unknown",o=e[2]||"Unknown",s=e[8]||"Unknown",r=e[4],l=""!==(e[23]||"").trim();n+=`<li>\n                        <span><strong>${l?`${a} <span class="pan-tick">✓</span>`:a}</strong><br><small>Father: ${o} | School: ${s}</small></span>\n                        <button type="button" onclick="openPanPopup('${r}', '${a}')">Edit PAN</button>\n                    </li>`})),n+="</ul>",t.innerHTML=n,status.innerText=`${e.rows.length} record(s) found.`,status.style.color="green"}else t.innerHTML='<p style="color:red; text-align:center;">No records found.</p>',status.innerText="No records found.",status.style.color="red"})).catch((e=>{loader.style.display="none",alert("Error searching by name.")}))):alert("Please enter a name to search.")}function openPanPopup(e,t){currentEditAadhaar=e,panTeacherName.innerText=t,panInput.value="",panPopup.style.display="flex"}function savePAN(){const e=panInput.value.trim().toUpperCase();if(!e.match(/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/))return void alert("Please enter a valid PAN (5 letters, 4 numbers, 1 letter)");if(!currentEditAadhaar)return void alert("No teacher selected.");loader.style.display="flex";const t=new URLSearchParams;t.append("action","updatePAN"),t.append("adhaar",currentEditAadhaar),t.append("pan",e),fetch(scriptURL,{method:"POST",body:t}).then((e=>e.text())).then((e=>{loader.style.display="none","UPDATED"===e||"SUCCESS"===e?(alert("PAN updated successfully."),panPopup.style.display="none"):alert("Error updating PAN.")})).catch((e=>{loader.style.display="none",alert("Error updating PAN.")}))}function cancelPan(){panPopup.style.display="none",currentEditAadhaar=null}function populateFormFromRow(e){form.name.value=e[1]||"",form.father_name.value=e[2]||"",form.dob.value=formatDate(e[3]),form.adhaar.value=e[4]||"",form.mobile.value=e[5]||"",form.email.value=e[6]||"";const t=e[7];if(t){const e=form.gender;for(let n=0;n<e.length;n++)if(e[n].value===t){e[n].checked=!0;break}}form.school_name.value=e[8]||"",form.udise.value=e[9]||"",form.teacher_type.value=e[10]||"";const n=e[11];if(n){const e=form.class_level;for(let t=0;t<e.length;t++)if(e[t].value===n){e[t].checked=!0;break}}form.subject.value=e[12]||"",form.doj.value=formatDate(e[13]),form.account_number.value=e[14]||"",form.bank_name.value=e[15]||"",form.ifsc.value=e[16]||"",form.village.value=e[17]||"",form.panchayat.value=e[18]||"",form.block.value=e[19]||"",form.district.value=e[20]||"",form.state.value=e[21]||"",form.pincode.value=e[22]||"",form.pan.value=e[23]||"",status.innerText="Record loaded. You can edit and re-submit.",status.style.color="green"}function formatDate(e){if(!e)return"";const t=new Date(e);return new Date(t.getTime()-6e4*t.getTimezoneOffset()).toISOString().split("T")[0]}window.addEventListener("hashchange",showSectionFromHash),window.addEventListener("load",showSectionFromHash),document.querySelectorAll(".mode-btn").forEach((e=>{e.addEventListener("click",(t=>{setMode(e.dataset.mode)}))})),backToModeBtn.addEventListener("click",(()=>{window.location.hash=""})),savePanBtn.addEventListener("click",savePAN),cancelPanBtn.addEventListener("click",cancelPan),form.addEventListener("submit",(e=>{e.preventDefault();form.querySelectorAll('input[type="text"]').forEach((e=>{e.value=e.value.toUpperCase()})),btn.disabled=!0,btn.innerText="Saving...",loader.style.display="flex",fetch(scriptURL,{method:"POST",body:new FormData(form),keepalive:!0}).then((e=>{loader.style.display="none",popupTitle.innerText="Success!",popupMessage.innerText="Data submitted successfully.",popup.style.display="flex",form.reset(),btn.disabled=!1,btn.innerText="Submit Data Securely",window.location.hash=""})).catch((e=>{loader.style.display="none",status.innerText="Error saving data.",btn.disabled=!1}))})),closePopupBtn.addEventListener("click",(()=>{popup.style.display="none"}));
